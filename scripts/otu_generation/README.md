<!-- #region -->
# OTU Generation Pipeline

## Overview

This repository contains two Python scripts designed to automate the generation of Operational Taxonomic Units (OTUs) from aligned FASTA files using [VSEARCH](https://github.com/torognes/vsearch).

The workflow:
1. Cleans aligned FASTA files by removing gap characters (`-`).
2. Clusters sequences into OTUs at a specified sequence identity threshold.
3. Produces representative (centroid) sequences and a mapping file linking individual sequences to their OTU.


## Repository Structure

```
.
├── generate_otus.py      # Main executable script with command-line arguments
├── otu_utils.py          # Module containing reusable functions
└── README.md
```
<!-- #endregion -->

## Requirements

- **Python** ≥ 3.8  
- **VSEARCH** ≥ 2.21.0 (must be installed and accessible from the system PATH)

Python dependencies (standard library only):
- `argparse`
- `pathlib`
- `subprocess`

---

## Input Directory Structure

The script assumes a root directory containing multiple subfolders, each with an `output` subdirectory containing an aligned FASTA file named:

```
aligned_sequences_mafft.fasta
```

Example:

```
/path/to/root/
├── Phylum_A/
│   └── output/
│       └── aligned_sequences_mafft.fasta
├── Phylum_B/
│   └── output/
│       └── aligned_sequences_mafft.fasta
└── ...
```

---

## Output Files

For each processed folder, an `otus/` subdirectory will be created inside the `output/` folder containing:

| File | Description |
|------|--------------|
| `aligned_sequences_cleaned.fasta` | Cleaned version of the original alignment (gaps removed). |
| `otus.fasta` | OTU centroid sequences generated by VSEARCH. |
| `otus.uc` | VSEARCH clustering output (cluster membership and identity details). |
| `otus_mapping.txt` | Tab-separated file mapping sequence IDs to OTU IDs. |

---

## Usage

Run the main script from the command line:

```bash
python generate_otus.py -r /path/to/root [-i 0.97] [--no-vsearch]
```

### Arguments

| Argument | Type | Default | Description |
|-----------|------|----------|-------------|
| `-r`, `--root` | Path | — | Root directory containing subfolders with aligned FASTA files (required). |
| `-i`, `--identity` | Float | 0.97 | Sequence identity threshold for clustering (VSEARCH `--id` parameter). |
| `--no-vsearch` | Flag | False | If specified, skips the clustering step and only performs FASTA cleaning. |

### Examples

Run full cleaning and clustering:
```bash
python generate_otus.py -r "/data/metabarcoding/root_dir" -i 0.99
```

Perform cleaning only (no VSEARCH clustering):
```bash
python generate_otus.py -r "/data/metabarcoding/root_dir" --no-vsearch
```

---

## Function Descriptions (in `otu_utils.py`)

| Function | Description |
|-----------|--------------|
| `clean_fasta(src, dest)` | Removes gaps from aligned FASTA files and writes the cleaned output. |
| `run_vsearch(fasta, centroids, uc_file, identity)` | Executes VSEARCH clustering with the specified identity threshold. |
| `build_mapping(uc_file, dest)` | Generates a tab-separated mapping file of sequences to OTUs from the `.uc` file. |
| `process_folder(folder, identity, run_vsearch_flag)` | Executes the complete pipeline (cleaning and optionally clustering) for one folder. |

---

## Notes

- The script assumes that VSEARCH is installed and callable from the command line (`vsearch` command).  
- The expected aligned FASTA file name is fixed (`aligned_sequences_mafft.fasta`).  
- Processing is performed recursively for all subfolders in the provided root directory that contain an `output/` subfolder.

---

## License

This code is distributed for research and academic use.  
Please cite appropriately if used in a publication.
